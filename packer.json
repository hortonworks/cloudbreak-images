{
  "variables": {
    "mock": "{{ env `MOCK` }}",
    "description": "{{ env `DESCRIPTION` }}",
    "gcp_account_file": "{{env `GCP_ACCOUNT_FILE`}}",
    "gcp_storage_bundle": "{{env `GCP_STORAGE_BUNDLE`}}",
    "gcp_ami_regions": "{{env `GCP_AMI_REGIONS`}}",
    "os_auth_url": "{{ env `OS_AUTH_URL` }}",
    "os_username": "{{ env `OS_USERNAME` }}",
    "os_password": "{{ env `OS_PASSWORD` }}",
    "os_tenant_name": "{{ env `OS_TENANT_NAME` }}",
    "client_id": "{{ env `ARM_CLIENT_ID` }}",
    "client_secret": "{{ env `ARM_CLIENT_SECRET` }}",
    "subscription_id": "{{ env `ARM_SUBSCRIPTION_ID` }}",
    "tenant_id": "{{ env `ARM_TENANT_ID` }}",
    "resource_group_name": "{{ env `ARM_GROUP_NAME` }}",
    "storage_account": "{{ env `ARM_STORAGE_ACCOUNT` }}",
    "virtual_network_resource_group_name": "{{ env `VIRTUAL_NETWORK_RESOURCE_GROUP_NAME` }}",
    "arm_build_region": "{{ env `ARM_BUILD_REGION` }}",
    "clustermanager_version": "{{ env `CLUSTERMANAGER_VERSION` }}",
    "clustermanager_baseurl": "{{ env `CLUSTERMANAGER_BASEURL` }}",
    "clustermanager_gpgkey": "{{ env `CLUSTERMANAGER_GPGKEY` }}",
    "pre_warm_parcels": "{{ env `PRE_WARM_PARCELS` }}",
    "pre_warm_csd": "{{ env `PRE_WARM_CSD` }}",
    "stack_type": "{{ env `STACK_TYPE` }}",
    "mpack_urls": "{{ env `MPACK_URLS` }}",
    "stack_version": "{{ env `STACK_VERSION` }}",
    "stack_repoid": "{{ env `STACK_REPOID` }}",
    "stack_baseurl": "{{ env `STACK_BASEURL` }}",
    "repository_version": "{{ env `STACK_REPOSITORY_VERSION` }}",
    "hdputil_version": "{{ env `HDPUTIL_VERSION` }}",
    "hdputil_repoid": "{{ env `HDPUTIL_REPOID` }}",
    "hdputil_baseurl": "{{ env `HDPUTIL_BASEURL` }}",
    "copy_aws_marketplace_eula": "{{ env `COPY_AWS_MARKETPLACE_EULA`}}",
    "git_rev": "{{ env `GIT_REV` }}",
    "git_branch": "{{ env `GIT_BRANCH` }}",
    "git_tag": "{{ env `GIT_TAG` }}",
    "os": "{{ env `OS` }}",
    "os_type": "{{ env `OS_TYPE` }}",
    "os_user": "cloudbreak",
    "ssh_password": "S3cr3t",
    "atlas_artifact": "cloudbreak",
    "atlas_artifact_type": "{{ env `ATLAS_ARTIFACT_TYPE` }}",
    "image_name": "{{ env `IMAGE_NAME` }}",
    "image_size": "{{ env `IMAGE_SIZE` }}",
    "image_owner": "{{ env `IMAGE_OWNER` }}",
    "prewarm_tag": "{{ env `PREWARM_TAG` }}",
    "include_fluent": "{{ env `INCLUDE_FLUENT` }}",
    "fluent_prewarm_tag": "{{env `FLUENT_PREWARM_TAG` }}",
    "include_metering": "{{ env `INCLUDE_METERING` }}",
    "metering_prewarm_tag": "{{env `METERING_PREWARM_TAG` }}",
    "include_cdp_telemetry": "{{ env `INCLUDE_CDP_TELEMETRY` }}",
    "cdp_telemetry_prewarm_tag": "{{env `CDP_TELEMETRY_PREWARM_TAG` }}",
    "azure_image_publisher": "{{ env `AZURE_IMAGE_PUBLISHER` }}",
    "azure_image_offer": "{{ env `AZURE_IMAGE_OFFER` }}",
    "azure_image_sku": "{{ env `AZURE_IMAGE_SKU` }}",
    "azure_storage_accounts": "{{ env `AZURE_STORAGE_ACCOUNTS` }}",
    "salt_install_os": "{{ env `SALT_INSTALL_OS` }}",
    "salt_install_repo": "{{ env `SALT_INSTALL_REPO` }}",
    "salt_version": "{{ env `SALT_VERSION` }}",
    "salt_path": "{{ env `SALT_PATH` }}",
    "pyzmq_version": "{{ env `PYZMQ_VERSION` }}",
    "aws_instance_type": "t3.2xlarge",
    "aws_ami_regions": "{{ env `AWS_AMI_REGIONS` }}",
    "aws_instance_profile": "{{ env `AWS_INSTANCE_PROFILE` }}",
    "custom_image_type": "{{ env `CUSTOM_IMAGE_TYPE` }}",
    "optional_states": "{{ env `OPTIONAL_STATES` }}",
    "oracle_jdk8_url_rpm": "{{ env `ORACLE_JDK8_URL_RPM` }}",
    "preinstalled_java_home": "{{ env `PREINSTALLED_JAVA_HOME` }}",
    "local_url_ambari": "{{ env `LOCAL_URL_AMBARI` }}",
    "local_url_hdp": "{{ env `LOCAL_URL_HDP` }}",
    "local_url_hdp_utils": "{{ env `LOCAL_URL_HDP_UTILS` }}",
    "repository_type": "{{ env `REPOSITORY_TYPE` }}",
    "sles_registration_code": "{{ env `SLES_REGISTRATION_CODE` }}",
    "package_versions" :  "{{ env `PACKAGE_VERSIONS` }}",
    "python_apt_version" : "{{ env `PYTHON_APT_VERSION` }}",
    "salt_repo_file": "{{ env `SALT_REPO_FILE` }}",
    "aws_snapshot_groups": "{{ env `AWS_SNAPSHOT_GROUPS` }}",
    "aws_ami_groups": "{{ env `AWS_AMI_GROUPS` }}",
    "tag_customer_delivered": "{{ env `TAG_CUSTOMER_DELIVERED` }}",
    "version": "{{ env `VERSION` }}",
    "parcels_root": "{{ env `PARCELS_ROOT` }}",
    "parcels_name": "{{ env `PARCELS_NAME` }}",
    "subnet_id": "{{ env `SUBNET_ID` }}",
    "vpc_id": "{{ env `VPC_ID` }}",
    "base_ami_id": "{{ env `BASE_AMI_ID` }}",
    "cm_build_number": "{{ env `CM_BUILD_NUMBER` }}",
    "stack_build_number": "{{ env `STACK_BUILD_NUMBER` }}",
    "composite_gbn": "{{ env `COMPOSITE_GBN` }}",
    "parcel_list_with_versions": "{{ env `PARCEL_LIST_WITH_VERSIONS` }}",
    "cdp_telemetry_version": "{{ env `CDP_TELEMETRY_VERSION` }}",
    "cdp_telemetry_rpm_url": "{{ env `CDP_TELEMETRY_RPM_URL` }}",
    "cdp_logging_agent_version": "{{ env `CDP_LOGGING_AGENT_VERSION` }}",
    "cdp_logging_agent_rpm_url": "{{ env `CDP_LOGGING_AGENT_RPM_URL` }}",
    "metadata_filename_postfix": "{{ env `METADATA_FILENAME_POSTFIX` }}",
    "jumpgate_agent_rpm_url": "{{ env `JUMPGATE_AGENT_RPM_URL` }}",
    "image_uuid": "{{ env `IMAGE_UUID` }}"
  },
  "builders": [
    {
      "name": "aws-centos7",
      "type": "amazon-ebs",
      "region": "us-west-1",
      "ssh_pty": true,
      "source_ami": "ami-098f55b4287a885ba",
      "instance_type": "{{ user `aws_instance_type` }}",
      "ssh_username": "centos",
      "ena_support": true,
      "skip_region_validation": true,
      "tags": {
        "builder": "packer",
        "version": "{{user `version`}}",
        "cb-creation-timestamp": "{{timestamp}}",
        "Owner": "{{ user `image_owner` }}",
        "Customer Delivered": "{{user `tag_customer_delivered`}}"
      },
      "run_tags": {
        "Owner": "{{ user `image_owner` }}"
      },
      "ami_block_device_mappings": [
        {
          "device_name": "/dev/sda1",
          "volume_type": "gp2",
          "delete_on_termination": true,
          "volume_size": "{{user `image_size`}}"
        }
      ],
      "launch_block_device_mappings": [
        {
          "device_name": "/dev/sda1",
          "volume_type": "gp2",
          "delete_on_termination": true,
          "volume_size": "{{user `image_size`}}"
        }
      ],
      "ami_name": "{{ user `image_name`}}",
      "subnet_id": "{{ user `subnet_id`}}",
      "vpc_id": "{{ user `vpc_id`}}"
    },
    {
      "name": "arm-centos7",
      "type": "azure-arm",
      "client_id": "{{user `client_id`}}",
      "client_secret": "{{user `client_secret`}}",
      "subscription_id": "{{user `subscription_id`}}",
      "tenant_id": "{{user `tenant_id`}}",
      "resource_group_name": "{{user `resource_group_name`}}",
      "storage_account": "{{user `storage_account`}}",
      "capture_container_name": "packer",
      "capture_name_prefix": "{{user `image_name`}}",
      "image_publisher": "{{user `azure_image_publisher`}}",
      "image_offer": "{{user `azure_image_offer`}}",
      "image_sku": "{{user `azure_image_sku`}}",
      "ssh_pty": "true",
      "username": "{{user `os_user`}}",
      "os_type": "Linux",
      "ssh_username": "centos",
      "ssh_password": "{{user `ssh_password`}}",
      "location": "{{user `arm_build_region`}}",
      "vm_size": "Standard_D4",
      "os_disk_size_gb": "{{user `image_size`}}",
      "virtual_network_resource_group_name":"{{user `virtual_network_resource_group_name`}}",
      "virtual_network_name": "{{user `vpc_id`}}",
      "virtual_network_subnet_name": "{{user `subnet_id`}}",
      "private_virtual_network_with_public_ip": false,
      "azure_tags": {
        "builder": "packer",
        "version": "{{user `version`}}",
        "cb-creation-timestamp": "{{timestamp}}",
        "Owner": "{{ user `image_owner` }}",
        "Customer Delivered": "{{user `tag_customer_delivered`}}"
      }
    },
    {
      "name": "gc-centos7",
      "type": "googlecompute",
      "disable_default_service_account" : true,
      "account_file": "{{user `gcp_account_file`}}",
      "source_image": "centos-7-v20200811",
      "zone": "us-west2-a",
      "project_id": "gcp-cdp-cb-images",
      "network_project_id": "gcp-eng-network-enterprise",
      "ssh_username": "centos",
      "ssh_pty": "true",
      "machine_type": "n1-standard-2",
      "preemptible": false,
      "omit_external_ip": "true",
      "use_internal_ip": "true",
      "network": "{{user `vpc_id`}}",
      "subnetwork": "{{user `subnet_id`}}",
      "image_name": "{{user `image_name`}}",
      "disk_size": "{{user `image_size`}}",
      "state_timeout": "15m",
      "tags": [
        "builder--packer",
        "cb-creation-timestamp--{{timestamp}}",
        "owner--{{ user `image_owner` | clean_resource_name }}",
        "customer-delivered--{{user `tag_customer_delivered` | clean_resource_name}}",
        "gcp-dev-cloudbreak-ingress-internet-deny",
        "gcp-dev-cloudbreak-egress-internet-allow",
        "gcp-dev-cloudbreak-ingress-rfc1918-allow"
      ]
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "saltstack",
      "destination": "/tmp/saltstack"
    },
    {
      "type": "file",
      "source": "repos",
      "destination": "/tmp/repos"
    },
    {
      "type": "file",
      "source": "scripts/salt_requirements.txt",
      "destination": "/tmp/salt_requirements.txt"
    },
    {
      "type": "file",
      "source": "scripts/hardcoded-packages.csv",
      "destination": "/tmp/hardcoded-packages.csv"
    },
    {
      "type": "shell",
      "script": "scripts/generate-delta-package-list.sh",
      "environment_vars": [
        "SALT_INSTALL_OS={{ user `salt_install_os` }}",
        "INSTALLATION_STATE=base"
      ],
      "execute_command": "chmod +x {{ .Path }}; sudo {{ .Vars }} {{ .Path }}"
    },
    {
      "type": "shell",
      "script": "scripts/salt-install.sh",
      "environment_vars": [
        "SALT_INSTALL_OS={{ user `salt_install_os` }}",
        "SALT_INSTALL_REPO={{user `salt_install_repo` }}",
        "SALT_VERSION={{user `salt_version`}}",
        "PYZMQ_VERSION={{user `pyzmq_version`}}",
        "SLES_REGISTRATION_CODE={{user `sles_registration_code`}}",
        "OS_TYPE={{user `os_type`}}",
        "OS={{user `os`}}",
        "PYTHON_APT_VERSION={{user `python_apt_version`}}",
        "SALT_PATH={{user `salt_path`}}",
        "SALT_REPO_FILE={{user `salt_repo_file` }}"
      ],
      "execute_command": "chmod +x {{ .Path }}; sudo {{ .Vars }} {{ .Path }}"
    },
    {
      "type": "shell",
      "script": "scripts/salt-setup.sh",
      "expect_disconnect": true,
      "execute_command": "chmod +x {{ .Path }}; sudo {{ .Vars }} {{ .Path }} ",
      "environment_vars": [
        "CUSTOM_IMAGE_TYPE={{user `custom_image_type`}}",
        "OS_USER={{ user `os_user` }}",
        "CLUSTERMANAGER_VERSION={{user `clustermanager_version`}}",
        "CLUSTERMANAGER_BASEURL={{user `clustermanager_baseurl`}}",
        "CLUSTERMANAGER_GPGKEY={{user `clustermanager_gpgkey`}}",
        "STACK_TYPE={{user `stack_type`}}",
        "MPACK_URLS={{user `mpack_urls`}}",
        "STACK_VERSION={{user `stack_version`}}",
        "STACK_REPOID={{user `stack_repoid`}}",
        "STACK_BASEURL={{user `stack_baseurl`}}",
        "HDPUTIL_VERSION={{user `hdputil_version`}}",
        "HDPUTIL_REPOID={{user `hdputil_repoid`}}",
        "HDPUTIL_BASEURL={{user `hdputil_baseurl`}}",
        "PREWARM_TAG={{user `prewarm_tag` }}",
        "INCLUDE_FLUENT={{user `include_fluent`}}",
        "FLUENT_PREWARM_TAG={{ user `fluent_prewarm_tag` }}",
        "METERING_PREWARM_TAG={{ user `metering_prewarm_tag` }}",
        "INCLUDE_CDP_TELEMETRY={{user `include_cdp_telemetry`}}",
        "CDP_TELEMETRY_PREWARM_TAG={{ user `cdp_telemetry_prewarm_tag` }}",
        "INCLUDE_METERING={{user `include_metering`}}",
        "CDP_TELEMETRY_VERSION={{user `cdp_telemetry_version`}}",
        "CDP_TELEMETRY_RPM_URL={{user `cdp_telemetry_rpm_url`}}",
        "CDP_LOGGING_AGENT_VERSION={{user `cdp_logging_agent_version`}}",
        "CDP_LOGGING_AGENT_RPM_URL={{user `cdp_logging_agent_rpm_url`}}",
        "JUMPGATE_AGENT_RPM_URL={{user `jumpgate_agent_rpm_url`}}",
        "OS={{user `os`}}",
        "GIT_REV={{user `git_rev`}}",
        "STACK_REPOSITORY_VERSION={{user `repository_version`}}",
        "COPY_AWS_MARKETPLACE_EULA={{user `copy_aws_marketplace_eula`}}",
        "ORACLE_JDK8_URL_RPM={{user `oracle_jdk8_url_rpm`}}",
        "OPTIONAL_STATES={{user `optional_states`}}",
        "PREINSTALLED_JAVA_HOME={{user `preinstalled_java_home`}}",
        "LOCAL_URL_AMBARI={{user `local_url_ambari`}}",
        "LOCAL_URL_HDP={{user `local_url_hdp`}}",
        "LOCAL_URL_HDP_UTILS={{user `local_url_hdp_utils`}}",
        "REPOSITORY_TYPE={{user `repository_type`}}",
        "SLES_REGISTRATION_CODE={{user `sles_registration_code`}}",
        "PACKAGE_VERSIONS={{user `package_versions`}}",
        "SALT_VERSION={{user `salt_version`}}",
        "SALT_PATH={{user `salt_path`}}",
        "PARCELS_ROOT={{ user `parcels_root` }}",
        "PARCELS_NAME={{ user `parcels_name` }}",
        "PRE_WARM_PARCELS={{ user `pre_warm_parcels` }}",
        "PRE_WARM_CSD={{ user `pre_warm_csd` }}"
      ]
    },
    {
      "type": "shell",
      "script": "scripts/generate-delta-package-list.sh",
      "environment_vars": [
        "SALT_INSTALL_OS={{ user `salt_install_os` }}",
        "INSTALLATION_STATE=complete",
        "SALT_PATH={{user `salt_path`}}",
        "PARCELS_NAME={{ user `parcels_name` }}",
        "STACK_BASEURL={{user `stack_baseurl`}}",
        "PRE_WARM_PARCELS={{ user `pre_warm_parcels` }}",
        "PRE_WARM_CSD={{ user `pre_warm_csd` }}"
      ],
      "execute_command": "chmod +x {{ .Path }}; sudo {{ .Vars }} {{ .Path }}"
    },
    {
      "type": "file",
      "source": "/tmp/package-versions.json",
      "destination": "package-versions.json",
      "direction" : "download"
    },
    {
      "type": "file",
      "source": "/tmp/installed-delta-packages.csv",
      "destination": "installed-delta-packages.csv",
      "direction" : "download"
    }
  ],
  "post-processors": [
    {
      "type": "manifest",
      "output": "{{ user `image_name` }}_{{ user `metadata_filename_postfix` }}_manifest.json"
    },
    {
      "type": "shell-local",
      "script": "scripts/pp_json.sh",
      "environment_vars": [
        "custom_image_type={{user `custom_image_type`}}",
        "created_at={{timestamp}}",
        "prometheus=true",
        "created={{ isotime \"2006-01-02 15:04:05 -0700\" }}",
        "git_rev={{user `git_rev`}}",
        "git_branch={{user `git_branch`}}",
        "git_tag={{user `git_tag`}}",
        "os={{user `os`}}",
        "os_user={{user `os_user` }}",
        "os_type={{user `os_type` }}",
        "orchestrator=salt",
        "image_name={{ user `image_name` }}",
        "description={{ user `description` }}",
        "clustermanager_version={{ user `clustermanager_version` }}",
        "clustermanager_os_type={{user `os_type`}}",
        "clustermanager_baseurl={{ user `clustermanager_baseurl` }}",
        "clustermanager_gpgkey={{ user `clustermanager_gpgkey` }}",
        "stack_type={{ user `stack_type` }}",
        "stack_os_type={{user `os_type`}}",
        "stack_version={{user `stack_version`}}",
        "stack_baseurl={{ user `stack_baseurl` }}",
        "stack_repoid={{ user `stack_repoid` }}",
        "stack_repository_version={{ user `repository_version`}}",
        "hdputil_version={{user `hdputil_version`}}",
        "hdputil_os_type={{user `os_type`}}",
        "hdputil_baseurl={{ user `hdputil_baseurl` }}",
        "hdputil_repoid={{ user `hdputil_repoid` }}",
        "mpack_urls={{ user `mpack_urls` }}",
        "aws_ami_regions={{ user `aws_ami_regions` }}",
        "azure_storage_accounts={{ user `azure_storage_accounts` }}",
        "gcp_storage_bundle={{ user `gcp_storage_bundle` }}",
        "gcp_ami_regions={{ user `gcp_ami_regions` }}",
        "local_url_ambari={{user `local_url_ambari`}}",
        "local_url_hdp={{user `local_url_hdp`}}",
        "local_url_hdp_utils={{user `local_url_hdp_utils`}}",
        "repository_type={{user `repository_type`}}",
        "pre_warm_parcels={{ user `pre_warm_parcels` }}",
        "pre_warm_csd={{ user `pre_warm_csd` }}",
        "cm_build_number={{ user `cm_build_number` }}",
        "stack_build_number={{ user `stack_build_number` }}",
        "composite_gbn={{ user `composite_gbn` }}",
        "parcel_list_with_versions={{ user `parcel_list_with_versions` }}",
        "metadata_filename_postfix={{ user `metadata_filename_postfix` }}",
        "image_uuid={{user `image_uuid`}}"
      ]
    }
  ]
}
