#!/bin/bash -ux

CCM_TUNNEL_ROLE=$1
CCM_TUNNEL_SERVICE_PORT=$2
cat > /cdp/bin/reverse-tunnel-values-${CCM_TUNNEL_ROLE}.sh <<EOF
CCM_HOST=${CCM_HOST}
CCM_SSH_PORT=${CCM_SSH_PORT}
CCM_PUBLIC_KEY_FILE=${CCM_PUBLIC_KEY_FILE}
CCM_TUNNEL_INITIATOR_ID=${CCM_TUNNEL_INITIATOR_ID}
CCM_KEY_ID=${CCM_KEY_ID}
CCM_ENCIPHERED_PRIVATE_KEY_FILE=${CCM_ENCIPHERED_PRIVATE_KEY_FILE}
CCM_TUNNEL_ROLE=${CCM_TUNNEL_ROLE}
CCM_TUNNEL_SERVICE_PORT=${CCM_TUNNEL_SERVICE_PORT}
EOF
chmod 740 /cdp/bin/reverse-tunnel-values-${CCM_TUNNEL_ROLE}.sh
systemctl enable ccm-tunnel@${CCM_TUNNEL_ROLE}.service
systemctl start ccm-tunnel@${CCM_TUNNEL_ROLE}.service
